name: Terraform and Gatling Workflow

on:
  push:
    branches:
      - main
  pull_request:

env:
  PROJECT_ID: 'sb-izal-20241001-134850'
  PROJECT_NO: '295291854751'
  GH_IDENTITY_POOL_ID: 'gh-identity-pool-third'

jobs:
  # Job 1: Terraform Deployment
  terraform:
    name: Deploy Infrastructure with Terraform
    runs-on: ubuntu-latest

    steps:
      # Step 1: Check out the GKE repository (with Terraform code)
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          repository: StrikerASD/python-app-gatling
          ref: main

      # Step 2: Authenticate to GCP with Workload Identity Federation
      - name: Authenticate with GCP
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      # Step 3: Set up Terraform
      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          cli_config_credentials_token: ${{ secrets.HASHICORP_TOKEN }}

      # Step 4: Initialize and Apply Terraform
      - name: Terraform Init and Apply
        run: |
          terraform init
          terraform apply -auto-approve
        working-directory: terraform

  # Job 2: Gatling Load Test
  gatling:
    name: Run Load Tests with Gatling
    runs-on: ubuntu-latest
    needs: terraform # Wait for Terraform job to finish

    steps:
      # Step 1: Check out the Python app repository (with Gatling config)
      - name: Checkout Python App repository
        uses: actions/checkout@v3
        with:
          repository: StrikerASD/python-app-gatling
          ref: main

      # Step 2: Authenticate to GCP (for pulling Gatling Docker image)
      - name: Authenticate with GCP
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      # Step 3: Configure Docker to use Artifact Registry
      - name: Configure Docker
        run: gcloud auth configure-docker europe-west3-docker.pkg.dev

      # Step 4: Pull and Run Gatling Docker Image
      - name: Run Gatling Load Test
        run: |
          docker run \
            -e BASE_URL=${{ secrets.BASE_URL }} \
            europe-west3-docker.pkg.dev/sb-izal-20241111-105308/gatling-images/gatling:latest


#name: Load Test
#
#on:
#  workflow_dispatch:
#    inputs:
#      target_url:
#        description: "The URL of the application to test"
#        required: true
#        default: "http://34.160.233.244"
#
#jobs:
#  load-test:
#    runs-on: ubuntu-latest
#
#    steps:
#      - name: Pull Gatling Docker Image
#        run: docker pull europe-west3-docker.pkg.dev/sb-izal-20241111-105308/gatling-images/gatling:latest
#
#      # - name: Run Gatling Load Test
#      #   env:
#      #     BASE_URL: ${{ inputs.target_url }}
#      #   run: |
#      #     docker run --rm \
#      #       -e BASE_URL=$BASE_URL \
#      #       europe-west3-docker.pkg.dev/your-project/gatling-images/gatling:latest
#      - name: Run Gatling Load Test
#        env:
#         BASE_URL: ${{ inputs.target_url }}
#        run: |
#          docker run --rm \
#            -e BASE_URL=$BASE_URL \
#            -v $GITHUB_WORKSPACE/simulations:/gatling/simulations \
#            europe-west3-docker.pkg.dev/sb-izal-20241111-105308/gatling-images/gatling:latest

